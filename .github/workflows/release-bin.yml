name: Release pre-built binaries for new tag

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Tag of release to upload binaries for
        required: true
  push:
    tags: [v*]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      -
        uses: actions/setup-go@v6
        with: { go-version: 1.25.7 }

      - run: |
          function build_and_archive() {
            GOOS=$2 GOARCH=$3 go build -o $1 cmd/hyprls/main.go
            tar -cvzf hyprls-$2-$4.tar.gz $1
            zip hyprls-$2-$4.zip $1
          }

          build_and_archive "hyprls.exe" "windows" "386" "x86"
          build_and_archive "hyprls.exe" "windows" "arm64" "aarch64"
          build_and_archive "hyprls.exe" "windows" "amd64" "x86_64"

          build_and_archive "hyprls" "darwin" "arm64" "aarch64"
          mv hyprls hyprls-macos
          build_and_archive "hyprls" "darwin" "amd64" "x86_64"

          build_and_archive "hyprls" "linux" "386" "x86"
          build_and_archive "hyprls" "linux" "riscv64" "riscv64"
          build_and_archive "hyprls" "linux" "arm64" "aarch64"
          build_and_archive "hyprls" "linux" "amd64" "x86_64"

          # for legacy reasons, we also alias linux/amd64 zip archive as hyprls.zip
          cp hyprls-linux-x86_64.zip hyprls.zip

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag || github.ref_name }}
          token: ${{ github.token }}
          files: |
            hyprls-windows-aarch64.tar.gz
            hyprls-windows-aarch64.zip
            hyprls-windows-x86_64.tar.gz
            hyprls-windows-x86_64.zip
            hyprls-windows-x86.tar.gz
            hyprls-windows-x86.zip
            hyprls-darwin-aarch64.tar.gz
            hyprls-darwin-aarch64.zip
            hyprls-darwin-x86_64.tar.gz
            hyprls-darwin-x86_64.zip
            hyprls-linux-aarch64.tar.gz
            hyprls-linux-aarch64.zip
            hyprls-linux-x86_64.tar.gz
            hyprls-linux-x86_64.zip
            hyprls-linux-riscv64.tar.gz
            hyprls-linux-riscv64.zip
            hyprls-linux-x86.tar.gz
            hyprls-linux-x86.zip
            hyprls.zip
            hyprls
            hyprls-macos
            hyprls.exe
